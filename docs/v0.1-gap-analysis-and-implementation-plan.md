# N1Hub.com v0.1 Gap Analysis & Implementation Plan

## Executive Summary

This document identifies gaps between the current N1Hub.com v0.1 implementation and the approved specification (`N1Hub.com_V0.1_Capsule_EN.approved.v1.2.0.json`), then provides a concrete implementation plan to achieve full v0.1 compliance.

## Gap Analysis Matrix

### ✅ Fully Implemented

| Requirement | Section | Status | Notes |
|------------|---------|--------|-------|
| 9-Step Pipeline | 5 | ✅ Complete | All steps (INGEST→REPORT) implemented |
| RAG Defaults | 30 | ✅ Complete | All defaults match spec (chunk_size=800, stride=200, top_k=6, etc.) |
| Basic Routes | 16 | ✅ Complete | /, /inbox, /capsules, /capsules/[id], /graph, /chat |
| Export JSON | 2 | ✅ Complete | Implemented in capsule-detail.tsx |
| Include in RAG Toggle | 2 | ✅ Complete | PATCH /api/capsules/:id endpoint |
| Rate Limiting | 22 | ✅ Complete | Redis-based with fallback |
| Feature Flags | 25 | ✅ Complete | Environment variable based |
| Observability Endpoints | 26-29 | ✅ Complete | retrieval, router, semantic-hash, pii |
| Validation System | - | ✅ Complete | CapsuleValidator with 13-point checklist |
| Link Suggester | - | ✅ Complete | Automatic graph edge suggestion |
| Error Taxonomy | - | ✅ Complete | Structured error classification |

### ⚠️ Partially Implemented

| Requirement | Section | Status | Gap Details |
|------------|---------|--------|-------------|
| RAG-Scope Profiles | 10 | ⚠️ Partial | Only tag-based scope implemented. Missing: "My Capsules" default, "All Public", "Collection: Inbox", Strict Citations Mode |
| RAG Answer Generation | 6 | ⚠️ Partial | Current implementation just concatenates summaries. Should use LLM for grounded answers per spec |
| Strict Citations | 10 | ⚠️ Partial | Not enforced - allows <2 sources. Should require ≥2 distinct capsule_ids when available |
| API Endpoints | 4 | ⚠️ Partial | Need to verify exact match with spec (scope parameters, etc.) |
| Privacy & Audit | 11 | ⚠️ Partial | PII detection exists, but audit logging for status changes/RAG toggles may be missing |

### ❌ Missing

| Requirement | Section | Priority | Impact |
|------------|---------|----------|--------|
| "My Capsules" RAG-Scope | 10 | High | Core feature - default scope should filter user's active capsules |
| "All Public" RAG-Scope | 10 | Medium | Public capsule browsing with score threshold |
| "Collection: Inbox" RAG-Scope | 10 | Medium | Filter by last 30 days of uploads |
| LLM-based Answer Generation | 6 | High | Current answer quality is too basic - just concatenation |
| Strict Citations Enforcement | 10 | High | Should require ≥2 sources when available |
| Audit Logging | 11 | Medium | Status changes and RAG toggles should be logged |
| Public Scope Score Threshold | 10 | Medium | Need routing threshold for public capsules |

## Implementation Plan

### Phase 1: RAG-Scope Profiles Enhancement (High Priority)

#### 1.1 Implement "My Capsules" Default Scope
**File**: `apps/engine/app/rag.py`, `apps/engine/app/store_pg.py`, `apps/engine/app/store.py`

**Changes**:
- Modify `ChatRequest` model to support scope type: `"my" | "public" | "tags:tag1,tag2" | "inbox"`
- Update `vector_search` and `search` methods to handle `scope="my"`:
  - Filter capsules where `include_in_rag=true` AND `status="active"`
  - Filter by user/author if user context available (for v0.1, may be all active capsules)
- Update `answer_chat` to default scope to `["my"]` if empty

**Files to modify**:
- `apps/engine/app/models.py` - Add scope type enum
- `apps/engine/app/rag.py` - Handle "my" scope in answer_chat
- `apps/engine/app/store_pg.py` - Update vector_search for "my" scope
- `apps/engine/app/store.py` - Update search for "my" scope

#### 1.2 Implement "Collection: Inbox" Scope (Last 30 Days)
**File**: `apps/engine/app/store_pg.py`, `apps/engine/app/store.py`

**Changes**:
- Add `scope="inbox"` handling:
  - Filter capsules where `created_at >= NOW() - INTERVAL '30 days'`
  - Combine with `include_in_rag=true` filter
- Update SQL queries to include date filtering

**Files to modify**:
- `apps/engine/app/store_pg.py` - Add date filtering in vector_search and search
- `apps/engine/app/store.py` - Add date filtering in MemoryCapsuleStore

#### 1.3 Implement "All Public" Scope with Score Threshold
**File**: `apps/engine/app/rag.py`, `apps/engine/app/store_pg.py`

**Changes**:
- Add `scope="public"` handling:
  - Filter capsules where `status="active"` (or add `public` status)
  - Apply score threshold (from settings or default 0.62)
  - Only include capsules meeting quality gate
- Add `public_score_threshold` to Settings

**Files to modify**:
- `apps/engine/app/config.py` - Add `public_score_threshold` setting
- `apps/engine/app/rag.py` - Filter by score threshold for public scope
- `apps/engine/app/store_pg.py` - Add public filtering logic

#### 1.4 Implement Strict Citations Mode
**File**: `apps/engine/app/rag.py`

**Changes**:
- Enforce ≥2 distinct capsule_ids requirement:
  - If `selected` capsules < 2, use fallback message
  - Update `_compose_answer` to require ≥2 sources
  - Update metrics to reflect citation compliance

**Files to modify**:
- `apps/engine/app/rag.py` - Update answer_chat to enforce ≥2 sources
- `apps/engine/app/models.py` - Add `strict_citations` flag to ChatRequest (optional)

### Phase 2: RAG Answer Quality Enhancement (High Priority)

#### 2.1 Integrate LLM for Answer Generation
**File**: `apps/engine/app/rag.py`

**Changes**:
- Replace `_compose_answer` with LLM-based generation:
  - Use LLM provider from settings (anthropic/openai)
  - Prompt: Use RAG-QUERY prompt from Prompt Library (Section 20-pack, capsule 18)
  - Input: Query + retrieved capsules (context)
  - Output: Grounded answer with inline citations 【capsule_id】
  - Enforce: Only use provided context, no external facts
- Add LLM client initialization in `config.py` or new `llm.py` module

**Files to create/modify**:
- `apps/engine/app/llm.py` - NEW: LLM client wrapper
- `apps/engine/app/rag.py` - Replace _compose_answer with LLM call
- `apps/engine/app/config.py` - Add LLM provider and API key settings

**Dependencies**:
- Install `anthropic` or `openai` package in `pyproject.toml`

### Phase 3: Audit Logging (Medium Priority)

#### 3.1 Add Audit Logging for Status Changes
**File**: `apps/engine/app/main.py`, `apps/engine/app/store_pg.py`

**Changes**:
- Create `audit_logs` table in SQL migration
- Log status changes when PATCH /capsules/:id updates status
- Include: capsule_id, old_status, new_status, timestamp, actor (if available)

**Files to create/modify**:
- `infra/sql/0003_audit_logs.sql` - NEW: Create audit_logs table
- `apps/engine/app/store_pg.py` - Add audit_log method
- `apps/engine/app/main.py` - Log status changes in PATCH endpoint

#### 3.2 Add Audit Logging for RAG Toggles
**File**: `apps/engine/app/main.py`, `apps/engine/app/store_pg.py`

**Changes**:
- Log when `include_in_rag` is toggled
- Include: capsule_id, old_value, new_value, timestamp, actor

**Files to modify**:
- `apps/engine/app/store_pg.py` - Add audit logging in update methods
- `apps/engine/app/main.py` - Log RAG toggle changes

### Phase 4: API Endpoint Verification & Enhancement (Medium Priority)

#### 4.1 Verify API Endpoint Compliance
**File**: `apps/interface/app/api/**/*.ts`, `apps/engine/app/main.py`

**Changes**:
- Verify all endpoints match spec Section 4:
  - `POST /api/import` → `/ingest` ✓
  - `GET /api/jobs/:id` → `/jobs/:id` ✓
  - `GET /api/capsules` → `/capsules` (verify scope parameter support)
  - `GET /api/capsules/:id` → `/capsules/:id` ✓
  - `PATCH /api/capsules/:id` → `/capsules/:id` (verify tags/status/RAG toggle) ✓
  - `POST /api/chat` → `/chat` (verify RAG-Scope support) ✓

**Files to review**:
- `apps/interface/app/api/capsules/route.ts` - Verify scope parameter
- `apps/engine/app/main.py` - Verify all endpoint signatures match spec

#### 4.2 Enhance RAG-Scope UI
**File**: `apps/interface/components/rag-scope-toggle.tsx`

**Changes**:
- Add scope type selector: "My Capsules", "All Public", "Collection: Inbox", "Tags"
- Update UI to show active scope type
- Pass scope type to API (not just tags)

**Files to modify**:
- `apps/interface/components/rag-scope-toggle.tsx` - Add scope type selector
- `apps/interface/lib/state.ts` - Update RagScopeState to include scope type
- `apps/interface/lib/api.ts` - Update runChat to send scope type

### Phase 5: Testing & Validation (High Priority)

#### 5.1 Add Integration Tests for RAG-Scope Profiles
**File**: `apps/engine/tests/test_rag_scopes.py` (NEW)

**Test Cases**:
- Test "my" scope filters correctly
- Test "inbox" scope filters by date
- Test "public" scope applies score threshold
- Test strict citations mode requires ≥2 sources
- Test tag-based scope still works

#### 5.2 Add Tests for LLM Answer Generation
**File**: `apps/engine/tests/test_rag_llm.py` (NEW)

**Test Cases**:
- Test LLM generates grounded answers
- Test citations are included in answer
- Test fallback when insufficient context
- Test answer stays within context bounds

#### 5.3 Update E2E Tests
**File**: `apps/engine/tests/test_pipeline_integration.py`

**Changes**:
- Add tests for different RAG-Scope profiles
- Verify citation requirements
- Test audit logging

## Implementation Order

1. **Phase 1.4** - Strict Citations Mode (Quick win, high impact)
2. **Phase 1.1** - "My Capsules" Default Scope (Core feature)
3. **Phase 2.1** - LLM Answer Generation (Quality improvement)
4. **Phase 1.2** - "Collection: Inbox" Scope
5. **Phase 1.3** - "All Public" Scope
6. **Phase 4.2** - RAG-Scope UI Enhancement
7. **Phase 3** - Audit Logging
8. **Phase 5** - Testing & Validation

## Success Criteria

- ✅ All RAG-Scope profiles from Section 10 implemented
- ✅ LLM-based answer generation with citations
- ✅ Strict citations mode enforced (≥2 sources when available)
- ✅ Audit logging for status changes and RAG toggles
- ✅ All API endpoints match spec exactly
- ✅ All tests pass
- ✅ End-to-end flow: Upload → Capsules → Graph → Chat with all scope types

## Estimated Effort

- Phase 1: 4-6 hours
- Phase 2: 3-4 hours
- Phase 3: 2-3 hours
- Phase 4: 2-3 hours
- Phase 5: 3-4 hours

**Total**: ~14-20 hours

## Notes

- LLM integration requires API keys - ensure environment variables are set
- Public scope may require additional database fields (public flag, score)
- Audit logging should be lightweight to avoid performance impact
- Backward compatibility: Existing tag-based scope should continue working
